<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="bwrob">
<meta name="dcterms.date" content="2024-05-12">
<meta name="description" content="How to chain resource managers in an elegant way.">

<title>Exit stack to the rescue – bwrob blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../logo/python_mug.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="bwrob blog">
<meta property="og:description" content="bwrob personal and professional blog">
<meta property="og:image" content="https://bwrob.github.io/posts/exit-stack/flowchart.png">
<meta property="og:site_name" content="bwrob blog">
<meta property="og:image:height" content="214">
<meta property="og:image:width" content="759">
<meta name="twitter:title" content="bwrob blog">
<meta name="twitter:description" content="bwrob personal and professional blog">
<meta name="twitter:image" content="https://bwrob.github.io/posts/exit-stack/flowchart.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="214">
<meta name="twitter:image-width" content="759">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../logo/python_mug.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">bwrob blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> <i class="bi bi-cpu" role="img">
</i> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/resume.html"> <i class="bi bi-file-earmark-text" role="img">
</i> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/teaching.html"> <i class="bi bi-tablet-landscape" role="img">
</i> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/hobbies.html"> <i class="bi bi-controller" role="img">
</i> 
<span class="menu-text">Hobbies</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/bartoszmwroblewski/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bwrob/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Exit stack to the rescue</h1>
                  <div>
        <div class="description">
          How to chain resource managers in an elegant way.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Pythonic Distractions</div>
                <div class="quarto-category">Context Managers</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>bwrob </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 12, 2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">August 30, 2024</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#working-with-risk-managment-systems" id="toc-working-with-risk-managment-systems" class="nav-link active" data-scroll-target="#working-with-risk-managment-systems">Working with risk managment systems</a></li>
  <li><a href="#setting-the-stage" id="toc-setting-the-stage" class="nav-link" data-scroll-target="#setting-the-stage">Setting the stage</a>
  <ul class="collapse">
  <li><a href="#mock-functions" id="toc-mock-functions" class="nav-link" data-scroll-target="#mock-functions">Mock functions</a></li>
  <li><a href="#context-managers" id="toc-context-managers" class="nav-link" data-scroll-target="#context-managers">Context managers</a></li>
  <li><a href="#analysis-results" id="toc-analysis-results" class="nav-link" data-scroll-target="#analysis-results">Analysis results</a></li>
  </ul></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a>
  <ul class="collapse">
  <li><a href="#using-contexts-directly" id="toc-using-contexts-directly" class="nav-link" data-scroll-target="#using-contexts-directly">Using contexts directly</a></li>
  </ul></li>
  <li><a href="#the-exitstack" id="toc-the-exitstack" class="nav-link" data-scroll-target="#the-exitstack">The ExitStack</a>
  <ul class="collapse">
  <li><a href="#disabling-the-clean-up" id="toc-disabling-the-clean-up" class="nav-link" data-scroll-target="#disabling-the-clean-up">Disabling the clean up</a></li>
  <li><a href="#multiple-portfolios" id="toc-multiple-portfolios" class="nav-link" data-scroll-target="#multiple-portfolios">Multiple portfolios</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="working-with-risk-managment-systems" class="level2">
<h2 class="anchored" data-anchor-id="working-with-risk-managment-systems">Working with risk managment systems</h2>
<p>As a quantitative finance professional you’ll often find yourself with risk management systems (RMS). RMS’s are extensive frameworks that let you properly define a book (portfolio) of your financial transactions and run varia of pricing and risk analysis on it. For big financial players, like investment banks, the RMS will be internal proprietary codbase that is run in-house. For smaller enterprises or second-line reporting it’s not feasable to tackle creating such vast infrastructure. Hence, where there’s a need, someone will try to make money on it. This leads us to third-party (or vendor) RMS, of which there are plenty (ex. Murex, Acadia).</p>
<p>Working with vendor RMS, especially one that covers computations for you, entails juggling multiple resources to obtain your risk metrics. Defining OTC products, benchmarks, portfolios, and running risk analysis can involve numerous API calls, each requiring proper setup and cleanup. This can lead to messy code and potential errors or performance bottlenecks if resources aren’t handled correctly.</p>
<p>Thankfully, Python provides a powerful concept called context managers (<strong>CM</strong>) that streamline resource managment. True to the language’s ‘batteries included’ philosophy, there’s also a <code>contextlib</code> library that contains variety of tools for easing up your work with CMs. Today we’ll look at a (mock-up) usage of <code>ExitStack</code> class in real-life scenario of running risk analysis on RMS. If you need a refresher on CMs, check out this <a href="https://realpython.com/python-with-statement/">tutorial</a> by RealPython.</p>
</section>
<section id="setting-the-stage" class="level2">
<h2 class="anchored" data-anchor-id="setting-the-stage">Setting the stage</h2>
<p>To run an analysis, the RMS first needs to know what our positions are. In case of tradable assets it’s simple — we provide a market identifier and how much of the instrument we are holding. What do we do if we have some bespoke agreement with specific counterparty (an over-the-counter transaction)? We will need to define it from scratch in the RMS using data from the term sheet (assuming this kind of agreement is covered).</p>
<p>Next, we need to specify the risk metrics we want to calculate — define the analysis scope. Let’s say we hold some equity options and we are intertested in their deltas and beta exposures. The betas are defined with respect to some benchmark — ex. portfolio holding 1 stock in US500 ETF. So we define the benchmark and link it to our analysis.</p>
<p>Finally — once portfolio and analysis are defined in RMS — we call the API to start the calculation and respond with results. This is the control flow we execute to get to this point:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  A[OTC Products] --&gt; B[Portfolio]
  B --&gt; C{Analysis Run}
  D[Benchmarks] --&gt; E[Analysis Definition]
  E --&gt; C
  C --&gt; F(Results)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>If we know we’re never going to use all of the resources, we should clean up the server artifacts after receving the results. So for each resource we should have a CM.</p>
<section id="mock-functions" class="level3">
<h3 class="anchored" data-anchor-id="mock-functions">Mock functions</h3>
<p>The setup described above comes from a real-life situation I worked through. I can’t show you the actual API usage or data (or even the name of RMS itself), so we need to define some mocker functions. Mocks like this are actually not an uncommon thing — such approach is prevalent in testing API client code. In our case it would look like this:</p>
<div id="8f84fc98" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">from</span> enum <span class="im">import</span> StrEnum</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">from</span> uuid <span class="im">import</span> uuid4</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw">class</span> MockObject(StrEnum):</span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="co">"""Types of mock objects."""</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>    ANALYSIS <span class="op">=</span> <span class="st">"analysis"</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>    BENCHMARK <span class="op">=</span> <span class="st">"benchmark"</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    OTC_PRODUCTS <span class="op">=</span> <span class="st">"otc_products"</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    PORTFOLIO <span class="op">=</span> <span class="st">"portfolio"</span></span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="kw">def</span> mock_object(object_type: MockObject) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="co">"""Mock a UUID for a given object type.</span></span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co">    Args:</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">        object_type: Type of object.</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co">    """</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>    <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>object_type<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>uuid4()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="kw">def</span> mock_preparation(object_type: MockObject, <span class="op">**</span>kwargs) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb1-24"><a href="#cb1-24"></a>    <span class="co">"""Mock preparation of an object.</span></span>
<span id="cb1-25"><a href="#cb1-25"></a></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">    Args:</span></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co">        object_type: Type of object.</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">    """</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>    <span class="bu">print</span>(<span class="ss">f"Preparing </span><span class="sc">{</span>object_type<span class="sc">}</span><span class="ss">"</span> <span class="op">+</span> (<span class="ss">f" using </span><span class="sc">{</span>kwargs<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> kwargs <span class="cf">else</span> <span class="st">"."</span>))</span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="kw">def</span> mock_clean_up(object_uuid: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb1-33"><a href="#cb1-33"></a>    <span class="co">"""Mock clean up of an object.</span></span>
<span id="cb1-34"><a href="#cb1-34"></a></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="co">    Args:</span></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="co">        object_uuid: Uuid of the object.</span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="co">    """</span></span>
<span id="cb1-38"><a href="#cb1-38"></a>    <span class="bu">print</span>(<span class="ss">f"Cleaning up after </span><span class="sc">{</span>object_uuid<span class="sc">}</span><span class="ss">."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each of the four types of resources we mock the preparation, object (ex. API response, some id of definition on server) and the clean up process.</p>
</section>
<section id="context-managers" class="level3">
<h3 class="anchored" data-anchor-id="context-managers">Context managers</h3>
<p>Easiest way to define a CM is through <code>contextlib.contextmanager</code> decorator. To use it, you need a function that returns a generator. Code executed on enter should come before <code>yield</code> statement and the one for the exit afterwards. The generator yields the result of the CM (ex. handle to an opened file), the <code>y</code> in <code>with x(*args) as y:</code>.</p>
<div id="9dc0238c" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">from</span> contextlib <span class="im">import</span> contextmanager</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">from</span> typing <span class="im">import</span> Generator</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="at">@contextmanager</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">def</span> analysis(</span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="op">*</span>,</span>
<span id="cb2-7"><a href="#cb2-7"></a>    benchmark_uuid: <span class="bu">str</span>,</span>
<span id="cb2-8"><a href="#cb2-8"></a>) <span class="op">-&gt;</span> Generator[<span class="bu">str</span>, <span class="va">None</span>, <span class="va">None</span>]:</span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="co">"""Mock definition of an analysis.</span></span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">    Example: equity delta and correlation with benchmark.</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">    Args:</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">        benchmark_uuid: Uuid of the benchmark.</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">    """</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>    mock_preparation(</span>
<span id="cb2-17"><a href="#cb2-17"></a>        MockObject.ANALYSIS,</span>
<span id="cb2-18"><a href="#cb2-18"></a>        benchmark_name<span class="op">=</span>benchmark_uuid,</span>
<span id="cb2-19"><a href="#cb2-19"></a>    )</span>
<span id="cb2-20"><a href="#cb2-20"></a>    analysis_uuid <span class="op">=</span> mock_object(MockObject.ANALYSIS)</span>
<span id="cb2-21"><a href="#cb2-21"></a>    <span class="cf">yield</span> analysis_uuid</span>
<span id="cb2-22"><a href="#cb2-22"></a>    mock_clean_up(analysis_uuid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Modern approach to Python development leans heavily towards type annotations. Dynamical typing is powerful but can lead to unwieldy code. To properly annotate the <code>analysis</code> function we need to import <code>Generator</code> from <code>typing</code> module. Remember, the <code>@contextmanager</code> decorator takes the function and turns it into CM — a class with <code>__enter__</code> and <code>__exit__</code> methods. The <code>Generator</code> needs three inputs but in our case only the first one is important — <code>YieldType</code>, here <code>str</code> (<a href="https://docs.python.org/3/library/typing.html#typing.Generator">see</a> for more).</p>
<p>With this done implementing the 3 remaining CMs is easy, just remember our flow chart.</p>
<div id="9cd7a04e" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="at">@contextmanager</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">def</span> benchmark() <span class="op">-&gt;</span> Generator[<span class="bu">str</span>, <span class="va">None</span>, <span class="va">None</span>]:</span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="co">"""Mock definition of a benchmark.</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">    Args:</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">        otc_products_uuid: Uuid of the otc products.</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">    """</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    mock_preparation(</span>
<span id="cb3-9"><a href="#cb3-9"></a>        MockObject.BENCHMARK,</span>
<span id="cb3-10"><a href="#cb3-10"></a>    )</span>
<span id="cb3-11"><a href="#cb3-11"></a>    benchmark_uuid <span class="op">=</span> mock_object(MockObject.BENCHMARK)</span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="cf">yield</span> benchmark_uuid</span>
<span id="cb3-13"><a href="#cb3-13"></a>    mock_clean_up(benchmark_uuid)</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="at">@contextmanager</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="kw">def</span> otc_products() <span class="op">-&gt;</span> Generator[<span class="bu">str</span>, <span class="va">None</span>, <span class="va">None</span>]:</span>
<span id="cb3-18"><a href="#cb3-18"></a>    <span class="co">"""Mock definition of an otc products.</span></span>
<span id="cb3-19"><a href="#cb3-19"></a></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">    Args:</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">        otc_products_uuid: Uuid of the otc products.</span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co">    """</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>    mock_preparation(MockObject.OTC_PRODUCTS)</span>
<span id="cb3-24"><a href="#cb3-24"></a>    otcs_uuid <span class="op">=</span> mock_object(MockObject.OTC_PRODUCTS)</span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="cf">yield</span> otcs_uuid</span>
<span id="cb3-26"><a href="#cb3-26"></a>    mock_clean_up(otcs_uuid)</span>
<span id="cb3-27"><a href="#cb3-27"></a></span>
<span id="cb3-28"><a href="#cb3-28"></a></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="at">@contextmanager</span></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="kw">def</span> portfolio(</span>
<span id="cb3-31"><a href="#cb3-31"></a>    <span class="op">*</span>,</span>
<span id="cb3-32"><a href="#cb3-32"></a>    portfolio_name: <span class="bu">str</span>,</span>
<span id="cb3-33"><a href="#cb3-33"></a>    otc_products_uuid: <span class="bu">str</span>,</span>
<span id="cb3-34"><a href="#cb3-34"></a>) <span class="op">-&gt;</span> Generator[<span class="bu">str</span>, <span class="va">None</span>, <span class="va">None</span>]:</span>
<span id="cb3-35"><a href="#cb3-35"></a>    <span class="co">"""Mock definition of a portfolio.</span></span>
<span id="cb3-36"><a href="#cb3-36"></a></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="co">    Args:</span></span>
<span id="cb3-38"><a href="#cb3-38"></a><span class="co">        otc_products_uuid: Uuid of the otc products.</span></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="co">    """</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>    mock_preparation(</span>
<span id="cb3-41"><a href="#cb3-41"></a>        MockObject.PORTFOLIO,</span>
<span id="cb3-42"><a href="#cb3-42"></a>        portfolio_name<span class="op">=</span>portfolio_name,</span>
<span id="cb3-43"><a href="#cb3-43"></a>        otc_products_uuid<span class="op">=</span>otc_products_uuid,</span>
<span id="cb3-44"><a href="#cb3-44"></a>    )</span>
<span id="cb3-45"><a href="#cb3-45"></a>    portfolio_uuid <span class="op">=</span> mock_object(MockObject.PORTFOLIO)</span>
<span id="cb3-46"><a href="#cb3-46"></a>    <span class="cf">yield</span> portfolio_uuid</span>
<span id="cb3-47"><a href="#cb3-47"></a>    mock_clean_up(portfolio_uuid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analysis-results" class="level3">
<h3 class="anchored" data-anchor-id="analysis-results">Analysis results</h3>
<p>No stress or complexity here, to run the analysis we need to specify which analysis to run on which portfolio.</p>
<div id="3525abef" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">def</span> analysis_results(</span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="op">*</span>,</span>
<span id="cb4-5"><a href="#cb4-5"></a>    analysis_uuid: <span class="bu">str</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>    portfolio_uuid: <span class="bu">str</span>,</span>
<span id="cb4-7"><a href="#cb4-7"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="co">"""Mock running the analysis on a given portfolio.</span></span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">    Returns empty dataframe.</span></span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">    Args:</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">        analysis_uuid: Uuid of the analysis.</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">        portfolio_uuid: Uuid of the portfolio.</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">    """</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="bu">print</span>(<span class="ss">f"Running analysis </span><span class="sc">{</span>analysis_uuid<span class="sc">}</span><span class="ss"> on portfolio </span><span class="sc">{</span>portfolio_uuid<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="cf">return</span> pd.DataFrame()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<p>Finally, we can run some (mock) risk analysis!</p>
<section id="using-contexts-directly" class="level3">
<h3 class="anchored" data-anchor-id="using-contexts-directly">Using contexts directly</h3>
<p>First, we use the managers directly through <code>with</code> clause, remembering the dependencies from our flow chart.</p>
<div id="40cc3f0e" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>PORTFOLIO <span class="op">=</span> <span class="st">"portfolio_1"</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">def</span> run_analysis() <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="co">"""Mock running the analysis using with clauses."""</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="cf">with</span> otc_products() <span class="im">as</span> otc_uuid:</span>
<span id="cb5-6"><a href="#cb5-6"></a>        <span class="cf">with</span> benchmark() <span class="im">as</span> benchmark_uuid:</span>
<span id="cb5-7"><a href="#cb5-7"></a>            <span class="cf">with</span> portfolio(</span>
<span id="cb5-8"><a href="#cb5-8"></a>                portfolio_name<span class="op">=</span>PORTFOLIO,</span>
<span id="cb5-9"><a href="#cb5-9"></a>                otc_products_uuid<span class="op">=</span>otc_uuid,</span>
<span id="cb5-10"><a href="#cb5-10"></a>            ) <span class="im">as</span> portfolio_uuid:</span>
<span id="cb5-11"><a href="#cb5-11"></a>                <span class="cf">with</span> analysis(</span>
<span id="cb5-12"><a href="#cb5-12"></a>                    benchmark_uuid<span class="op">=</span>benchmark_uuid,</span>
<span id="cb5-13"><a href="#cb5-13"></a>                ) <span class="im">as</span> analysis_uuid:</span>
<span id="cb5-14"><a href="#cb5-14"></a>                    results <span class="op">=</span> analysis_results(</span>
<span id="cb5-15"><a href="#cb5-15"></a>                        analysis_uuid<span class="op">=</span>analysis_uuid,</span>
<span id="cb5-16"><a href="#cb5-16"></a>                        portfolio_uuid<span class="op">=</span>portfolio_uuid,</span>
<span id="cb5-17"><a href="#cb5-17"></a>                    )</span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is terrible! I am already getting lost, needed few tries to get it right. We ended up with <strong>6</strong> levels of indentation, the code is confusing, the flow is obtuse. Let’s run it either way, to see if at least works.</p>
<div id="d1e302c5" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">def</span> print_title(title: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="co">"""Print a title padded, surrounded by dashes and empty lines."""</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> title.center(<span class="dv">60</span>, <span class="st">"-"</span>) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>print_title(<span class="st">"Running analysis."</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a>run_analysis()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
---------------------Running analysis.----------------------

Preparing otc_products.
Preparing benchmark.
Preparing portfolio using {'portfolio_name': 'portfolio_1', 'otc_products_uuid': 'otc_products_a4e69542-d026-4654-a188-66342bd88eb1'}
Preparing analysis using {'benchmark_name': 'benchmark_826e0a31-fb09-43c2-91a1-b999389faf27'}
Running analysis analysis_60ea9fae-ba5b-47f8-969d-647bbec47c80 on portfolio portfolio_389fbe56-d644-4ad9-90a8-0ee4afeb3236.
Cleaning up after analysis_60ea9fae-ba5b-47f8-969d-647bbec47c80.
Cleaning up after portfolio_389fbe56-d644-4ad9-90a8-0ee4afeb3236.
Cleaning up after benchmark_826e0a31-fb09-43c2-91a1-b999389faf27.
Cleaning up after otc_products_a4e69542-d026-4654-a188-66342bd88eb1.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
<p>Great, the behaviour is as expected, everything is cleaned after nicely. We achieved the goal but the code is unmaintainable. Looks like a subject of the joke <em>“good code makes your job safe for a day, but terrible code in production makes it safe for a lifetime”</em>. Being reckless and with no regard to job security as we are, we’ll fix it.</p>
<p><em>I can clearly recall the most unamanagable and unreadable code I’ve seen in my career and the culprit was fired in the end. Different reasons, long time later, but still. So the joke is just a joke, don’t rely on a bad code as your job insurance.</em></p>
</section>
</section>
<section id="the-exitstack" class="level2">
<h2 class="anchored" data-anchor-id="the-exitstack">The ExitStack</h2>
<p>Here comes in the MVP — <code>ExitStack</code> from <code>contextlib</code>, made for streamlining complex context managment situationships. Conceptually it’s just a First-In-Last-Out (FILO) stack. You put CMs on top, one by one. When CM is pushed to stack, its <code>__enter__</code> method is called and you can intercept the result. ExitStack is a CM itself, it’s <code>__exit__</code> method is just calling the exits of CMs in reverse order.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    A(Enter CM A) ---&gt; B(Enter CM B)
    B ---&gt; C(Enter CM C)
    C ---&gt; D[Do stuff]
    D ---&gt; E(Exit CM C)
    E ---&gt; F(Exit CM B)
    F ---&gt; G(Exit CM A)
    A -.- G
    B -.- F
    C -.- E

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>So the flow is exactly the same as in our first attempt. Let’s try it!</p>
<div id="0c814048" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">from</span> contextlib <span class="im">import</span> ExitStack</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">def</span> run_analysis_with_exit_stack() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="co">"""Mock running the analysis using exit stack."""</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>    <span class="cf">with</span> ExitStack() <span class="im">as</span> stack:</span>
<span id="cb8-6"><a href="#cb8-6"></a>        otc_uuid <span class="op">=</span> stack.enter_context(otc_products())</span>
<span id="cb8-7"><a href="#cb8-7"></a>        benchmark_uuid <span class="op">=</span> stack.enter_context(benchmark())</span>
<span id="cb8-8"><a href="#cb8-8"></a>        portfolio_uuid <span class="op">=</span> stack.enter_context(</span>
<span id="cb8-9"><a href="#cb8-9"></a>            portfolio(</span>
<span id="cb8-10"><a href="#cb8-10"></a>                portfolio_name<span class="op">=</span>PORTFOLIO,</span>
<span id="cb8-11"><a href="#cb8-11"></a>                otc_products_uuid<span class="op">=</span>otc_uuid,</span>
<span id="cb8-12"><a href="#cb8-12"></a>            )</span>
<span id="cb8-13"><a href="#cb8-13"></a>        )</span>
<span id="cb8-14"><a href="#cb8-14"></a>        analysis_uuid <span class="op">=</span> stack.enter_context(</span>
<span id="cb8-15"><a href="#cb8-15"></a>            analysis(</span>
<span id="cb8-16"><a href="#cb8-16"></a>                benchmark_uuid<span class="op">=</span>benchmark_uuid,</span>
<span id="cb8-17"><a href="#cb8-17"></a>            )</span>
<span id="cb8-18"><a href="#cb8-18"></a>        )</span>
<span id="cb8-19"><a href="#cb8-19"></a>        results <span class="op">=</span> analysis_results(</span>
<span id="cb8-20"><a href="#cb8-20"></a>            analysis_uuid<span class="op">=</span>analysis_uuid,</span>
<span id="cb8-21"><a href="#cb8-21"></a>            portfolio_uuid<span class="op">=</span>portfolio_uuid,</span>
<span id="cb8-22"><a href="#cb8-22"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s amazing (if the approach works)! In our code we end up with only single <code>with</code> clause and the outputs of CMs are defined just like the regular variables. We just need to wrap the CM calls in <code>stack.enter_context</code> method that pushes each CM to the stack.</p>
<div id="8ad1dffc" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>print_title(<span class="st">"Running analysis with exit stack."</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a>run_analysis_with_exit_stack()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
-------------Running analysis with exit stack.--------------

Preparing otc_products.
Preparing benchmark.
Preparing portfolio using {'portfolio_name': 'portfolio_1', 'otc_products_uuid': 'otc_products_e5c1ebba-5a98-45b7-8ced-ebf81cb7f489'}
Preparing analysis using {'benchmark_name': 'benchmark_c1ff6213-08d2-467a-959e-04a683194c5a'}
Running analysis analysis_8e2a8b78-8547-49b8-8a2b-957ef0716844 on portfolio portfolio_fe35f334-95f8-4bcc-a8ae-729c07436605.
Cleaning up after analysis_8e2a8b78-8547-49b8-8a2b-957ef0716844.
Cleaning up after portfolio_fe35f334-95f8-4bcc-a8ae-729c07436605.
Cleaning up after benchmark_c1ff6213-08d2-467a-959e-04a683194c5a.
Cleaning up after otc_products_e5c1ebba-5a98-45b7-8ced-ebf81cb7f489.</code></pre>
</div>
</div>
<p>It works as well! We also get a package of benefits for free.</p>
<section id="disabling-the-clean-up" class="level3">
<h3 class="anchored" data-anchor-id="disabling-the-clean-up">Disabling the clean up</h3>
<p>Working with API is tricky and debugging could be a painful experience. If we notice something iffy with the results we are reciving, it could be due to a bug at any of the stages. In such case disabling the artifact clean up and examining them is a good way to investigate. How do we do that? Comment out the exit code in our resource CMs? Nope, now we know better. With exit stack approach we just need to clean up the stack before exiting its context.</p>
<div id="052be2da" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">def</span> run_analysis_with_exit_stack(</span>
<span id="cb11-2"><a href="#cb11-2"></a>    clean_up: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb11-3"><a href="#cb11-3"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb11-4"><a href="#cb11-4"></a>    <span class="co">"""Mock running the analysis using exit stack.</span></span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">    Args:</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co">        clean_up: Whether to clean up after the objects.</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">    """</span></span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="cf">with</span> ExitStack() <span class="im">as</span> stack:</span>
<span id="cb11-11"><a href="#cb11-11"></a>        otc_uuid <span class="op">=</span> stack.enter_context(otc_products())</span>
<span id="cb11-12"><a href="#cb11-12"></a>        benchmark_uuid <span class="op">=</span> stack.enter_context(benchmark())</span>
<span id="cb11-13"><a href="#cb11-13"></a>        portfolio_uuid <span class="op">=</span> stack.enter_context(</span>
<span id="cb11-14"><a href="#cb11-14"></a>            portfolio(</span>
<span id="cb11-15"><a href="#cb11-15"></a>                portfolio_name<span class="op">=</span>PORTFOLIO,</span>
<span id="cb11-16"><a href="#cb11-16"></a>                otc_products_uuid<span class="op">=</span>otc_uuid,</span>
<span id="cb11-17"><a href="#cb11-17"></a>            )</span>
<span id="cb11-18"><a href="#cb11-18"></a>        )</span>
<span id="cb11-19"><a href="#cb11-19"></a>        analysis_uuid <span class="op">=</span> stack.enter_context(</span>
<span id="cb11-20"><a href="#cb11-20"></a>            analysis(</span>
<span id="cb11-21"><a href="#cb11-21"></a>                benchmark_uuid<span class="op">=</span>benchmark_uuid,</span>
<span id="cb11-22"><a href="#cb11-22"></a>            )</span>
<span id="cb11-23"><a href="#cb11-23"></a>        )</span>
<span id="cb11-24"><a href="#cb11-24"></a>        results <span class="op">=</span> analysis_results(</span>
<span id="cb11-25"><a href="#cb11-25"></a>            analysis_uuid<span class="op">=</span>analysis_uuid,</span>
<span id="cb11-26"><a href="#cb11-26"></a>            portfolio_uuid<span class="op">=</span>portfolio_uuid,</span>
<span id="cb11-27"><a href="#cb11-27"></a>        )</span>
<span id="cb11-28"><a href="#cb11-28"></a></span>
<span id="cb11-29"><a href="#cb11-29"></a>        <span class="cf">if</span> <span class="kw">not</span> clean_up:</span>
<span id="cb11-30"><a href="#cb11-30"></a>            _ <span class="op">=</span> stack.pop_all()</span>
<span id="cb11-31"><a href="#cb11-31"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>_ = some_function()</code> is a Pythonic way of disregarding outputs of <code>some_function</code>. Method <code>pop_all</code> actually moves the stack contents to a new stack, but we don’t care about that. We just want to get rid of them from our current one.</p>
<div id="f608417e" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>print_title(<span class="st">"Running analysis with exit stack and no clean up."</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a>run_analysis_with_exit_stack(clean_up<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
-----Running analysis with exit stack and no clean up.------

Preparing otc_products.
Preparing benchmark.
Preparing portfolio using {'portfolio_name': 'portfolio_1', 'otc_products_uuid': 'otc_products_837b8755-4b5c-4e54-9fb8-b348d587e7cb'}
Preparing analysis using {'benchmark_name': 'benchmark_c4ebfbd5-b754-4559-9aa7-65729261721d'}
Running analysis analysis_898ae960-c62b-4bda-b982-e64732989247 on portfolio portfolio_c4eaccd4-eb14-4bc0-9d97-dc70b58a510b.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="multiple-portfolios" class="level3">
<h3 class="anchored" data-anchor-id="multiple-portfolios">Multiple portfolios</h3>
<p>Benefit #2 — what do we do if we have multiple managers and many portfolios to re-run for? Or — outside of the example scope — we want to held multiple files open at the same time? Easy, we just push to the stack in a loop or a list comprehension.</p>
<div id="a040d744" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>PORTFOLIOS <span class="op">=</span> [<span class="st">"portfolio_1"</span>, <span class="st">"portfolio_2"</span>, <span class="st">"portfolio_3"</span>]</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw">def</span> run_analysis_with_exit_stack(clean_up: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="co">"""Mock running the analysis for multiple portfolios using exit stack.</span></span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="co">    Args:</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="co">        clean_up: Whether to clean up after the objects.</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co">    """</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>    <span class="cf">with</span> ExitStack() <span class="im">as</span> stack:</span>
<span id="cb14-10"><a href="#cb14-10"></a>        otc_uuid <span class="op">=</span> stack.enter_context(otc_products())</span>
<span id="cb14-11"><a href="#cb14-11"></a>        benchmark_uuid <span class="op">=</span> stack.enter_context(benchmark())</span>
<span id="cb14-12"><a href="#cb14-12"></a>        portfolio_uuids <span class="op">=</span> [</span>
<span id="cb14-13"><a href="#cb14-13"></a>            stack.enter_context(</span>
<span id="cb14-14"><a href="#cb14-14"></a>                portfolio(</span>
<span id="cb14-15"><a href="#cb14-15"></a>                    portfolio_name<span class="op">=</span>portfolio_name,</span>
<span id="cb14-16"><a href="#cb14-16"></a>                    otc_products_uuid<span class="op">=</span>otc_uuid,</span>
<span id="cb14-17"><a href="#cb14-17"></a>                )</span>
<span id="cb14-18"><a href="#cb14-18"></a>            )</span>
<span id="cb14-19"><a href="#cb14-19"></a>            <span class="cf">for</span> portfolio_name <span class="kw">in</span> PORTFOLIOS</span>
<span id="cb14-20"><a href="#cb14-20"></a>        ]</span>
<span id="cb14-21"><a href="#cb14-21"></a>        analysis_uuid <span class="op">=</span> stack.enter_context(</span>
<span id="cb14-22"><a href="#cb14-22"></a>            analysis(</span>
<span id="cb14-23"><a href="#cb14-23"></a>                benchmark_uuid<span class="op">=</span>benchmark_uuid,</span>
<span id="cb14-24"><a href="#cb14-24"></a>            )</span>
<span id="cb14-25"><a href="#cb14-25"></a>        )</span>
<span id="cb14-26"><a href="#cb14-26"></a>        result_parts <span class="op">=</span> [</span>
<span id="cb14-27"><a href="#cb14-27"></a>            analysis_results(</span>
<span id="cb14-28"><a href="#cb14-28"></a>                analysis_uuid<span class="op">=</span>analysis_uuid,</span>
<span id="cb14-29"><a href="#cb14-29"></a>                portfolio_uuid<span class="op">=</span>portfolio_uuid,</span>
<span id="cb14-30"><a href="#cb14-30"></a>            )</span>
<span id="cb14-31"><a href="#cb14-31"></a>            <span class="cf">for</span> portfolio_uuid <span class="kw">in</span> portfolio_uuids</span>
<span id="cb14-32"><a href="#cb14-32"></a>        ]</span>
<span id="cb14-33"><a href="#cb14-33"></a>        results <span class="op">=</span> pd.concat(result_parts)</span>
<span id="cb14-34"><a href="#cb14-34"></a></span>
<span id="cb14-35"><a href="#cb14-35"></a>        <span class="cf">if</span> <span class="kw">not</span> clean_up:</span>
<span id="cb14-36"><a href="#cb14-36"></a>            _ <span class="op">=</span> stack.pop_all()</span>
<span id="cb14-37"><a href="#cb14-37"></a>    <span class="cf">return</span> results</span>
<span id="cb14-38"><a href="#cb14-38"></a></span>
<span id="cb14-39"><a href="#cb14-39"></a>print_title(<span class="st">"Running analysis with exit stack on multiple portfolios."</span>)</span>
<span id="cb14-40"><a href="#cb14-40"></a>run_analysis_with_exit_stack(clean_up<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--Running analysis with exit stack on multiple portfolios.--

Preparing otc_products.
Preparing benchmark.
Preparing portfolio using {'portfolio_name': 'portfolio_1', 'otc_products_uuid': 'otc_products_01550eed-7c91-4bd8-b494-cc62222697c5'}
Preparing portfolio using {'portfolio_name': 'portfolio_2', 'otc_products_uuid': 'otc_products_01550eed-7c91-4bd8-b494-cc62222697c5'}
Preparing portfolio using {'portfolio_name': 'portfolio_3', 'otc_products_uuid': 'otc_products_01550eed-7c91-4bd8-b494-cc62222697c5'}
Preparing analysis using {'benchmark_name': 'benchmark_b059c2db-94ee-45e2-8780-13f1258f27d8'}
Running analysis analysis_4aba0acd-845e-4515-b67b-81a48ea87a8b on portfolio portfolio_e1f79a70-4cc3-4ffa-97dd-d16ba686b952.
Running analysis analysis_4aba0acd-845e-4515-b67b-81a48ea87a8b on portfolio portfolio_3cf7a522-2e2e-41f5-99da-e92f5c32c29a.
Running analysis analysis_4aba0acd-845e-4515-b67b-81a48ea87a8b on portfolio portfolio_dd0f42dc-9cbc-4d60-8d55-1c68d23ac528.
Cleaning up after analysis_4aba0acd-845e-4515-b67b-81a48ea87a8b.
Cleaning up after portfolio_dd0f42dc-9cbc-4d60-8d55-1c68d23ac528.
Cleaning up after portfolio_3cf7a522-2e2e-41f5-99da-e92f5c32c29a.
Cleaning up after portfolio_e1f79a70-4cc3-4ffa-97dd-d16ba686b952.
Cleaning up after benchmark_b059c2db-94ee-45e2-8780-13f1258f27d8.
Cleaning up after otc_products_01550eed-7c91-4bd8-b494-cc62222697c5.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Today we’ve learnt a new Python tool and seen an example of how quantitative developer might set up risk reporting job on vendor RMS. Sound like a very niche and unlikely situation for you? Maybe. But the moral here is to go and explore the Python standard library. Without using any additional packages we improved readability and flexibility of our initial attempt. Python really has <em>‘batteries included’</em>, <a href="https://docs.python.org/3/library/index.html">see</a> for yourself!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Download the whole code <a href="../../scripts/exit_stack.py">here</a>.</p>
</div>
</div>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/bwrob\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, bwrob</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>